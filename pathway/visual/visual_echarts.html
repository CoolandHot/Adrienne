<!DOCTYPE html>
<html style="height: 100%">

<head>
  <meta charset="utf-8" />
  <style>
    #para-settings {
      position: fixed;
      z-index: 1;
      margin-top: 25px;
      /* background-color: rgb(255, 255, 255) */
      font-size: 1em;
      color: white;
    }
  </style>
</head>

<body style="height: 99%; width: 99%; margin: 0">
  <div id="para-settings">
    number of common genes threshod:
    <label for="threshold_slider">1</label>
    <input type="range" min="0" max="120" value="1" id="threshold_slider">
  </div>

  <div id="container" style="height: 100%"></div>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <script type="text/javascript">
    var myChart = echarts.init(document.getElementById("container"), "dark");
    var graph_data;

    const slider = document.querySelector('#threshold_slider');
    slider.addEventListener('input', () => {
      var threshold = slider.value;
      document.querySelector("label[for='threshold_slider']").innerText = threshold;
      update_series(threshold)
    });

    var chart_option = {

      toolbox: {
        show: true,
        feature: {
          myTool1: {
            show: true,
            title: 'upload json data',
            icon: 'path://M512 0c-282.77 0-512 229.23-512 512s229.23 512 512 512 512-229.23 512-512-229.23-512-512-512zM768 576h-256v192h-128v-192h-256l384-384 384 384z',
            onclick: function () {
              var input = document.createElement('input');
              input.type = 'file';
              input.onchange = function () {
                console.log("load " + input.files[0].name)
                make_graph(input)
              };
              input.click();
            }
          },
          dataView: { readOnly: true },
          saveAsImage: {}
        }
      },
    };


    var make_graph = async (json_path) => {
      if (json_path instanceof HTMLInputElement) {
        const file = json_path.files[0];
        graph_data = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            resolve(JSON.parse(reader.result));
          };
          reader.readAsText(file);
        });
      } else {
        const response = await fetch(json_path);
        graph_data = await response.json();
      }
      chart_option['title'] = {
        text: "Pathway connections",
      }
      if (graph_data.hasOwnProperty('title')) {
        chart_option['title'] = {
          text: graph_data.title,
        }
      }
      chart_option['legend'] = {
        data: graph_data.groups.map((a) => {
          return a.name;
        }),
        bottom: "3%",
        left: "1%"
      }

      chart_option['series'] = [
        {
          type: "graph",
          layout: 'force',
          categories: graph_data.groups,
          data: graph_data.nodes.map(function (node) {
            return {
              id: node.id,
              name: node.id,
              category: node.group,
            };
          }),
          links: graph_data.links.filter(l => l.value > 0),
          emphasis: {
            focus: 'adjacency',
            label: {
              position: 'right',
              show: true
            },
            edgeLabel: {
              show: true,
              formatter: "{c} common genes"
            }
          },
          roam: true,
          lineStyle: {
            width: 0.5,
            curveness: 0.3,
            opacity: 0.7
          }
        },
      ]

      myChart.setOption(chart_option);
    }

    const update_series = (shared_gene_threshold) => {
      myChart.clear();
      myChart.showLoading();

      chart_option['series'][0]['links'] = graph_data.links.filter(l => l.value > shared_gene_threshold)

      myChart.setOption(chart_option);
      myChart.hideLoading();
    }

    make_graph("./graph_data_doseDiff_longTerm.json")

  </script>
</body>

</html>